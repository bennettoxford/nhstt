---
title: "How to use the monthly activity and performance data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{how-to-activity-performance-monthly}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

> **Note:** This guide is for illustration purposes only and may contain errors. It demonstrates example usage of the dataset and functions, but results should not be interpreted as validated analyses.

This example demonstrates how to explore monthly NHS Talking Therapies reports using the `nhstt` package.
We'll look at changes in monthly measures related to different treatment end codes broken down by individual NHS Talking Therapies providers.

## Setup

We start by loading the necessary packages and downloading the monthly activity performance dataset with `get_activity_performance_monthly()`. This report contains monthly performance indicators for NHS Talking Therapies services across England.

```{r setup, message=FALSE, warning=FALSE}
# Load packages
library(nhstt)
library(ggplot2)
library(dplyr)
library(scales)
library(stringr)
library(gt)

# Get all monthly activity performance reports
activity_performance <- get_activity_performance_monthly(
  periods = c(
    "2025-09", "2025-08", "2025-07", "2025-06", "2025-05", 
    "2025-04", "2025-03", "2025-02", "2025-01", "2024-12",
    "2024-11", "2024-10", "2024-09"
    )
)

# Define measure ids to explore
referral_ended_measures <- c(
  "M057", "M058", "M059", "M060", "M061", "M066", "M340", "M062",
  "M063", "M066", "M344", "M341", "M069", "M342", "M070", "M071"
)
```

## Select data for analysis

We want to explore changes in the following measures related to referrals that ended:

```{r tab-measures, echo=FALSE}
monthly_metadata <- get_metadata_monthly()

monthly_metadata |> 
  filter(measure_id %in% referral_ended_measures) |> 
  select(measure_id, description) |> 
  gt() |> 
  tab_style(
    style = list(
      cell_text(align = "left", v_align = "top")
    ),
    locations = cells_body(columns = measure_id)
  ) |> 
  tab_style(
    style = list(
      cell_text(align = "left", v_align = "top")
    ),
    locations = cells_body(columns = description)
  ) |> 
  cols_label(
    measure_id = "ID",
    description = "Description"
  )
```

Here we filter the data to include all measures as defined above in `referral_ended_measures` for all providers:

```{r select-data}
selected_activity_performance <- activity_performance |>
  filter(measure_id %in% c(referral_ended_measures)) |>
  filter(group_type == "Provider")
```

## Create figure

Finally, we visualise the trends over time broken down by codes for referrals that ended for each service provider.

```{r fig-example, warning=FALSE, message=FALSE, echo=FALSE, fig.height = 12, fig.width = 10, fig.cap = "Trends for counts of different referrals that ended measures."}

end_dates <- unique(selected_activity_performance$end_date)
fig_date_breaks <- end_dates[seq(4, length(end_dates), by = 4)]

measure_name_to_sentence <- function(x) {
  x |>
    str_remove("^ended_") |>
    str_replace_all("_", " ") |>
    str_to_sentence()
}

fig_selected_activity_performance <- selected_activity_performance |>
  mutate(
measure_name_id = paste0(
  measure_name_to_sentence(measure_name),
      " (",
      measure_id,
      ")"
    )
  ) |>
    select(end_date, org_name2, org_code2, measure_id, measure_name_id, value)
  
levels_order <- fig_selected_activity_performance %>%
    distinct(measure_id, measure_name_id) %>%
    arrange(measure_id) %>%
    pull(measure_name_id)

fig_ref_ended_by_service <- fig_selected_activity_performance |>
  mutate(measure_name_id = factor(measure_name_id, levels = levels_order)) |> 
  ggplot(
    aes(
      y = value,
      x = end_date,
      colour = measure_name_id,
      group = org_code2
    )
  ) +
  geom_line(alpha = 0.2) +
  geom_point(size = .2) +
  labs(
    title = NULL,
    x = "End date of yearly interval",
    y = NULL,
    colour = NULL,
    shape = NULL
  ) +
  scale_x_date(
    # breaks = fig_date_breaks,
    labels = label_date("%b\n%Y")
  ) +
  scale_y_continuous(
    labels = label_number(accuracy = 1),
    limits = c(0, NA)
  ) +
  theme(
    legend.position = "bottom",
    text = element_text(size = 13)
  ) +
  facet_wrap(
    vars(measure_name_id),
    scales = "free_y",
    ncol = 3
  ) +
  guides(colour = guide_legend(nrow = 5, byrow = TRUE))

fig_ref_ended_by_service
```