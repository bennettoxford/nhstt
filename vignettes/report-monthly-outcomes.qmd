---
title: "Monthly treatment outcome measures"
format: html
execute:
  echo: false
vignette: >
  %\VignetteIndexEntry{Monthly treatment outcome measures}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| label: setup
#| include: false
#| warning: false

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

> **Note:** This report is in active development and designed for feedback on the user interface and visualisation methods. We have not done data assurance, results need to be interpreted carefully.


```{r}
#| label: get-data
#| include: false
#| warning: false

library(nhstt)
library(tidyverse)
library(highcharter)

df_ap <- get_activity_performance_monthly() |>
  filter(measure_id %in% c("M185")) |>
  select(
    end_date,
    org_code2,
    org_name2,
    measure_id,
    measure_statistic,
    value
  ) |>
  filter(org_code2 != "all") |>
  mutate(percentile = NA) |>
  relocate(percentile, .before = value)

df_ap_percentiles <- df_ap |>
  summarise_percentiles(
    period_col = end_date,
    value_col = value,
    group_by = c(measure_id, measure_statistic)
  ) |>
  mutate(
    org_code2 = NA_character_,
    org_name2 = NA_character_,
    measure_statistic = paste0(measure_statistic, "_percentile"),
    value = round(value, 1)
  )

df_plot <- df_ap |>
  bind_rows(df_ap_percentiles) |>
  arrange(end_date, measure_id, org_code2, measure_statistic)

```

## Percentile trends over time

```{r}
#| label: prep-data-for-ojs
#| include: false

# Prepare percentile data
df_m185_percentiles_ojs <- df_ap_percentiles |>
  filter(
    measure_id == "M185",
    measure_statistic == "count_percentile"
  ) |>
  arrange(end_date, percentile)

# Pass data to OJS
ojs_define(percentile_data = df_m185_percentiles_ojs)
```

```{ojs}
//| label: highcharts-import

Highcharts = require("https://code.highcharts.com/highcharts.js")
```

```{ojs}
//| label: percentile-colors

PERCENTILE_COLORS = ({
  10: "rgba(65, 105, 225, 0.2)",
  20: "rgba(65, 105, 225, 0.35)",
  30: "rgba(65, 105, 225, 0.4)",
  40: "rgba(65, 105, 225, 0.45)",
  50: "rgba(220, 20, 60, 0.65)",
  60: "rgba(65, 105, 225, 0.45)",
  70: "rgba(65, 105, 225, 0.4)",
  80: "rgba(65, 105, 225, 0.35)",
  90: "rgba(65, 105, 225, 0.2)"
})
```

```{ojs}
//| label: prepare-percentile-series

function preparePercentileSeries(data, colors) {
  return transpose(data)
    .reduce((acc, row) => {
      const p = row.percentile;
      if (!acc[p]) {
        acc[p] = {
          name: `P${p}`,
          type: 'line',
          color: colors[p],
          data: [],
          marker: { enabled: true, radius: 3, symbol: 'circle' }
        };
      }
      acc[p].data.push([new Date(row.end_date).getTime(), row.value]);
      return acc;
    }, {});
}
```

```{ojs}
//| label: chart-config

function createChartConfig(series, yAxisLabel) {
  return {
    title: { text: null },
    xAxis: {
      type: 'datetime',
      title: { text: '' }
    },
    yAxis: {
      title: { text: yAxisLabel }
    },
    tooltip: {
      shared: false,
      xDateFormat: '%B %Y',
      headerFormat: '<span style="font-size: 14px; font-weight: bold">{point.key}</span><br/>'
    },
    legend: {
      enabled: true,
      align: 'center',
      verticalAlign: 'bottom',
      itemStyle: { fontSize: '12px' }
    },
    series: series,
    credits: { enabled: false }
  };
}
```

```{ojs}
//| label: plot-percentiles-m185

{
  const series = Object.values(preparePercentileSeries(percentile_data, PERCENTILE_COLORS));
  const config = createChartConfig(series, 'M185');
  const container = html`<div style="width: 100%; height: 500px;"></div>`;

  Highcharts.chart(container, config);

  return container;
}
```