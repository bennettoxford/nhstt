---
title: "Monthly treatment outcome measures"
format: html
execute:
  echo: false
vignette: >
  %\VignetteIndexEntry{Monthly treatment outcome measures}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

{{< include _shared-code.qmd >}}

```{r}
#| label: prepare-data
#| warning: false
#| message: false
#| echo: false

library(nhstt)
library(tidyverse)
library(reactable)

# Metadata for the three treatment outcome measures
metadata_outcomes <- get_metadata_monthly() |>
  filter(measure_id %in% c("M186", "M192", "M195")) |>
  select(measure_id, description)

# Helper function to prepare plot data for a measure
prepare_plot_data <- function(data, measure) {
  data |>
    filter(measure_id == measure) |>
    select(
      reporting_period,
      start_date,
      end_date,
      org_code2,
      org_name2,
      measure_id,
      value
    ) |>
    arrange(org_code2, reporting_period) |>
    mutate(
      org_name_clean = nhstt:::clean_org_names(org_name2),
      org_name_code = paste0(org_name_clean, " (", org_code2, ")")
    ) |>
    select(start_date, end_date, value, org_name_code, org_code2, measure_id)
}

# Get monthly activity performance data
ap <- get_activity_performance_monthly()

# Prepare plot data for all three measures (keep NAs for gap visualization)
plot_data_m186 <- prepare_plot_data(ap, "M186")
plot_data_m192 <- prepare_plot_data(ap, "M192")
plot_data_m195 <- prepare_plot_data(ap, "M195")

# Prepare organisation list for filtering (from M186 data)
org_list <- plot_data_m186 |>
  distinct(org_code2, org_name_code) |>
  arrange(org_code2)

# Pass data to Observable
ojs_define(plot_data_m186_ojs = plot_data_m186)
ojs_define(plot_data_m192_ojs = plot_data_m192)
ojs_define(plot_data_m195_ojs = plot_data_m195)
ojs_define(org_list_ojs = org_list)
```

> **Note:** This report is in active development and designed for feedback on the user interface and visualisation methods. We have not done data assurance, results need to be interpreted carefully.

### Measures

```{r}
#| label: tab-measures-outcomes
#| echo: false

reactable(
  metadata_outcomes,
  searchable = FALSE,
  sortable = FALSE,
  searchMethod = JS(
    "function(rows, columnIds, filterValue) {
    return rows.filter(function(row) {
      var measure = String(row.values['measure_id']).toLowerCase();
      var desc = String(row.values['description']).toLowerCase();
      var search = filterValue.toLowerCase();
      return measure.indexOf(search) >= 0 || desc.indexOf(search) >= 0;
    });
  }"
  ),
  defaultPageSize = nrow(metadata_outcomes),
  columns = list(
    measure_id = colDef(
      name = "Measure ID and description",
      cell = function(value, index) {
        description <- metadata_outcomes$description[index]
        htmltools::tags$div(
          htmltools::tags$code(
            style = "color: #2A788EFF;",
            value
          ),
          ": ",
          description
        )
      }
    ),
    description = colDef(show = FALSE)
  ),
  outlined = TRUE,
  striped = TRUE
)
```

```{ojs}
//| label: convert-report-data

// Convert R data to JavaScript arrays
plotDataM186 = convertPlotData(transpose(plot_data_m186_ojs))
plotDataM192 = convertPlotData(transpose(plot_data_m192_ojs))
plotDataM195 = convertPlotData(transpose(plot_data_m195_ojs))
organisations = transpose(org_list_ojs)
```

### Select NHS TT providers

```{ojs}
//| label: search-select-input

viewof searchAndSelect = {
  const maxReached = selectedOrgs.length >= CONFIG.maxSelections;

  const container = html`<div class="nhstt-container">
    <div class="nhstt-input-group-wrapper">
      <div class="nhstt-input-group">
        <input
          type="text"
          class="nhstt-input"
          placeholder="Search by name or code (min ${CONFIG.minSearchLength} characters) and select provider ..."
          value=""
        />
        <select class="nhstt-select" ${maxReached ? 'disabled' : ''}>
          <option value="">${maxReached ? `Max ${CONFIG.maxSelections} selected` : 'Select provider'}</option>
        </select>
      </div>
    </div>
  </div>`;

  const input = container.querySelector('input');
  const select = container.querySelector('select');
  container.value = { searchQuery: "", orgToAdd: null };

  function updateDropdownOptions(searchQuery) {
    if (!searchQuery || searchQuery.length < CONFIG.minSearchLength) {
      select.innerHTML = `<option value="">Enter at least ${CONFIG.minSearchLength} characters</option>`;
      select.disabled = true;
      return;
    }

    if (maxReached) {
      select.innerHTML = `<option value="">Max ${CONFIG.maxSelections} selected</option>`;
      select.disabled = true;
      return;
    }

    const lowerQuery = searchQuery.toLowerCase();
    const filteredOrgs = organisations.filter(org =>
      org.org_name_code.toLowerCase().includes(lowerQuery)
    );

    if (filteredOrgs.length === 0) {
      select.innerHTML = '<option value="">No results</option>';
      select.disabled = true;
      return;
    }

    const availableOrgs = filteredOrgs.filter(org =>
      !selectedOrgs.some(selected => selected.org_code2 === org.org_code2)
    );

    select.disabled = false;
    select.innerHTML = `<option value="">Select (${availableOrgs.length} found)</option>`;

    availableOrgs.forEach((org, i) => {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = org.org_name_code;
      select.appendChild(option);
    });

    select._availableOrgs = availableOrgs;
  }

  input.addEventListener('input', (e) => {
    const searchQuery = e.target.value;
    container.value = { ...container.value, searchQuery };
    updateDropdownOptions(searchQuery);
    container.dispatchEvent(new Event('input'));
  });

  select.addEventListener('change', (e) => {
    const index = parseInt(e.target.value);
    if (isNaN(index) || !select._availableOrgs) return;

    const selectedOrg = select._availableOrgs[index];
    container.value = { ...container.value, orgToAdd: selectedOrg };
    container.dispatchEvent(new Event('input'));
    e.target.value = "";
  });

  return container;
}

// Extract values from search/select component
searchQuery = searchAndSelect.searchQuery
orgToAdd = searchAndSelect.orgToAdd

// Add organisation to selected list when dropdown changes
addOrgEffect = {
  if (orgToAdd && selectedOrgs.length < CONFIG.maxSelections) {
    const alreadySelected = selectedOrgs.some(org => org.org_code2 === orgToAdd.org_code2);
    if (!alreadySelected) {
      mutable selectedOrgs = [...selectedOrgs, orgToAdd];
    }
  }
  return null;
}
```

```{ojs}
//| label: selection-display

selectedOrgDisplay = {
  const container = html`<div class="nhstt-container" style="margin-bottom: 12px;"></div>`;
  const resultBox = document.createElement('div');

  if (selectedOrgs.length === CONFIG.maxSelections) {
    resultBox.className = 'nhstt-result-box at-max';
  } else {
    resultBox.className = 'nhstt-result-box';
  }

  if (selectedOrgs.length === 0) {
    const emptyMsg = document.createElement('span');
    emptyMsg.className = 'nhstt-result-empty';
    emptyMsg.textContent = 'No provider selected';
    resultBox.appendChild(emptyMsg);
  } else {
    const chipContainer = document.createElement('div');
    chipContainer.className = 'nhstt-chip-container';

    const sizeClass = selectedOrgs.length === CONFIG.maxSelections ? 'has-three'
                    : selectedOrgs.length === 2 ? 'has-two'
                    : 'has-one';

    selectedOrgs.forEach(org => {
      const chip = document.createElement('div');
      chip.className = `nhstt-chip ${sizeClass}`;
      chip.style.backgroundColor = getSelectedOrgBgColor(org.org_code2);

      const label = document.createElement('span');
      label.className = 'nhstt-chip-label';
      label.textContent = org.org_name_code;
      label.title = org.org_name_code;
      chip.appendChild(label);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'nhstt-chip-remove';
      removeBtn.innerHTML = 'Ã—';
      removeBtn.title = 'Remove';
      removeBtn.onclick = () => {
        mutable selectedOrgs = selectedOrgs.filter(o => o.org_code2 !== org.org_code2);
      };
      chip.appendChild(removeBtn);

      chipContainer.appendChild(chip);
    });

    resultBox.appendChild(chipContainer);
  }

  container.appendChild(resultBox);
  return container;
}
```

### Reliable improvement (M186)

```{ojs}
//| label: time-series-plot-m186

plotM186 = createTimeSeriesPlot(plotDataM186, "Reliable improvement (%)", [0, 100])
```

### Recovery (M192)

```{ojs}
//| label: time-series-plot-m192

plotM192 = createTimeSeriesPlot(plotDataM192, "Recovery (%)", [0, 100])
```

### Reliable recovery (M195)

```{ojs}
//| label: time-series-plot-m195

plotM195 = createTimeSeriesPlot(plotDataM195, "Reliable recovery (%)", [0, 100])
```
